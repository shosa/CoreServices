events {
    worker_connections 1024;
}

http {
    # Risoluzione DNS di Docker per i container
    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;

    client_max_body_size 100M;

    ########################################
    # Upstream definitions
    ##############c##########################

    # CoreHub
    upstream corehub-backend {
        server corehub-backend:3005;
    }

    upstream corehub-frontend {
        server corehub-frontend:3000;
    }

    # CoreMachine
    upstream coremachine-backend {
        server coremachine-backend:3001;
    }

    upstream coremachine-frontend {
        server coremachine-frontend:3000;
    }

    # CoreDocument
    upstream coredocument-backend {
        server coredocument-backend:3003;
    }

    upstream coredocument-frontend {
        server coredocument-frontend:3000;
    }

    # CoreDocument
    upstream corevisitor-backend {
        server corevisitor-backend:3006;
    }

    upstream corevisitor-frontend {
        server corevisitor-frontend:3000;
    }

    ########################################
    # CoreHub - Porta 80
    ########################################
    server {
        listen 80;
        server_name _;

        location /api {
            proxy_pass http://corehub-backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://corehub-frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreMachine - Porta 81
    ########################################
    server {
        listen 81;
        server_name _;

        location /api {
            proxy_pass http://coremachine-backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://coremachine-frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreDocument - Porta 82
    ########################################
    server {
        listen 82;
        server_name _;

        location /api {
            proxy_pass http://coredocument-backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://coredocument-frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreVisitor - Porta 83
    ########################################
    server {
        listen 83;
        server_name _;

        location /api {
            proxy_pass http://corevisitor-backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://corevisitor-frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }
}
