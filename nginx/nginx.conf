events {
    worker_connections 1024;
}

http {
    # Risoluzione DNS di Docker per i container
    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;

    client_max_body_size 100M;

    ########################################
    # Upstream definitions - NON PIÃ™ USATI
    # Usando variabili con resolver per risoluzione dinamica
    ########################################

    ########################################
    # CoreHub - Porta 80
    ########################################
    server {
        listen 80;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $corehub_backend "corehub-backend:3005";
        set $corehub_frontend "corehub-frontend:3000";

        location /api {
            proxy_pass http://$corehub_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$corehub_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreMachine - Porta 81
    ########################################
    server {
        listen 81;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $coremachine_backend "coremachine-backend:3001";
        set $coremachine_frontend "coremachine-frontend:3000";

        location /api {
            proxy_pass http://$coremachine_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$coremachine_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreDocument - Porta 82
    ########################################
    server {
        listen 82;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $coredocument_backend "coredocument-backend:3003";
        set $coredocument_frontend "coredocument-frontend:3000";

        location /api {
            proxy_pass http://$coredocument_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$coredocument_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreVisitor - Porta 83
    ########################################
    server {
        listen 83;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $corevisitor_backend "corevisitor-backend:3006";
        set $corevisitor_frontend "corevisitor-frontend:3000";

        location /api {
            proxy_pass http://$corevisitor_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$corevisitor_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreGre - Porta 84
    ########################################
    server {
        listen 84;
        server_name _;

        # Variabile per risoluzione dinamica DNS
        set $coregre_app "coregre-app:80";

        location / {
            proxy_pass http://$coregre_app;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host:$server_port;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;

            # Headers specifici per PHP
            proxy_set_header X-Forwarded-Host $host:$server_port;
            proxy_set_header X-Forwarded-Port $server_port;

            # Redirect handling - preserve port
            proxy_redirect http://$host/ http://$host:$server_port/;
            proxy_redirect http://$host:80/ http://$host:$server_port/;
        }
    }
}
