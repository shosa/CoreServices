events {
    worker_connections 1024;
}

http {
    # Risoluzione DNS di Docker per i container
    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;

    client_max_body_size 100M;

    ########################################
    # Upstream definitions - NON PIÃ™ USATI
    # Usando variabili con resolver per risoluzione dinamica
    ########################################

    ########################################
    # CoreHub - Porta 80
    ########################################
    server {
        listen 80;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $corehub_backend "corehub-backend:3005";
        set $corehub_frontend "corehub-frontend:3000";

        location /api {
            proxy_pass http://$corehub_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$corehub_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreMachine - Porta 81
    ########################################
    server {
        listen 81;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $coremachine_backend "coremachine-backend:3001";
        set $coremachine_frontend "coremachine-frontend:3000";

        location /api {
            proxy_pass http://$coremachine_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$coremachine_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreDocument - Porta 82
    ########################################
    server {
        listen 82;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $coredocument_backend "coredocument-backend:3003";
        set $coredocument_frontend "coredocument-frontend:3000";

        location /api {
            proxy_pass http://$coredocument_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$coredocument_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreVisitor - Porta 83
    ########################################
    server {
        listen 83;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $corevisitor_backend "corevisitor-backend:3006";
        set $corevisitor_frontend "corevisitor-frontend:3000";

        location /api {
            proxy_pass http://$corevisitor_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$corevisitor_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreGREJS Mobile PWA - Porta 84
    ########################################
    server {
        listen 84;
        server_name _;

        # Variabile per risoluzione dinamica DNS
        set $coregrejs_mobile "coregrejs-mobile:3012";
        set $coregrejs_backend "coregrejs-backend:3011";

        # Proxy per API backend (per foto e altre risorse)
        location /api/ {
            proxy_pass http://$coregrejs_backend/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Headers per upload file
            client_max_body_size 10M;
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
        }

        # Mobile PWA app
        location / {
            proxy_pass http://$coregrejs_mobile;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreVisitor Kiosk - Porta 85
    ########################################
    server {
        listen 85;
        server_name _;

        # Variabile per risoluzione dinamica DNS
        set $corevisitor_kiosk "corevisitor-kiosk:80";

        location / {
            proxy_pass http://$corevisitor_kiosk;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ########################################
    # CoreGREJS - Porta 86
    ########################################
    server {
        listen 86;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $coregrejs_backend "coregrejs-backend:3011";
        set $coregrejs_frontend "coregrejs-frontend:3000";

        location /api {
            proxy_pass http://$coregrejs_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$coregrejs_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }
    ########################################
    # CoreCanvas - Porta 88
    ########################################
    server {
        listen 88;
        server_name _;

        # Variabili per risoluzione dinamica DNS
        set $corecanvas_backend "corecanvas-backend:3014";
        set $corecanvas_frontend "corecanvas-frontend:3000";

        location /api {
            proxy_pass http://$corecanvas_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location / {
            proxy_pass http://$corecanvas_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

}
